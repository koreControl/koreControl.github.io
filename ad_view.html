<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ad Processor</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #050505;
    overflow: hidden;
    font-family: monospace;
}

#root {
    position: relative;
    width: 100%;
    height: 100%;
}

/* Ad container MUST be % based, not vw/vh */
#ad {
    position: absolute;
    inset: 0;
    background: white;
    display: block;
}

/* Cooldown screen */
#home {
    position: absolute;
    inset: 0;
    background: #050505;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

#home h2 {
    color: orange;
    margin: 4px;
}

#home p {
    color: #aaa;
    font-size: 12px;
}
</style>
</head>

<body>

<div id="root">
    <div id="ad"></div>

    <div id="home">
        <h2>COOLING DOWN</h2>
        <p>Next cycle in <span id="count">40</span>s</p>
    </div>
</div>

<script>
const SMARTLINK = "https://www.effectivegatecpm.com/cw1ee9zt3?key=166a8de6e9417228de30d751d42c81fb";
const VIEW_TIME = 20000;
const COOLDOWN  = 40000;

function forceRepaint() {
    // Qt WebEngine repaint hack
    document.body.style.display = "none";
    void document.body.offsetHeight;
    document.body.style.display = "block";
}

function startAd() {
    const root = document.getElementById("root");
    const oldAd = document.getElementById("ad");

    // HARD replace ad container (prevents white freeze)
    const newAd = document.createElement("div");
    newAd.id = "ad";
    newAd.style.position = "absolute";
    newAd.style.inset = "0";
    newAd.style.background = "white";

    root.replaceChild(newAd, oldAd);

    document.getElementById("home").style.display = "none";
    newAd.style.display = "block";

    const iframe = document.createElement("iframe");
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    iframe.src = SMARTLINK;

    newAd.appendChild(iframe);

    forceRepaint();

    setTimeout(startCooldown, VIEW_TIME);
}

function startCooldown() {
    document.getElementById("ad").style.display = "none";

    const home = document.getElementById("home");
    home.style.display = "flex";

    let t = COOLDOWN / 1000;
    document.getElementById("count").textContent = t;

    forceRepaint();

    const iv = setInterval(() => {
        t--;
        document.getElementById("count").textContent = t;
        if (t <= 0) {
            clearInterval(iv);
            startAd();
        }
    }, 1000);
}

// Absolute safety reload (Qt memory poison)
setTimeout(() => location.reload(), 15 * 60 * 1000);

// START
startAd();
</script>

</body>
</html>
