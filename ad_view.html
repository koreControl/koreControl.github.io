<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ad Processor</title>

<style>
body {
    margin: 0;
    background: #050505;
    overflow: hidden;
    font-family: monospace;
    height: 100vh;
}

#home {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

#home h2 {
    color: #00ff00;
    font-size: 18px;
    margin: 4px;
}

#home p {
    color: #888;
    font-size: 12px;
}

#spinner {
    width: 18px;
    height: 18px;
    border: 2px solid #333;
    border-top: 2px solid #00ff00;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

#ad {
    position: absolute;
    inset: 0;
    display: none;
    background: white;
}
</style>
</head>

<body>

<div id="home">
    <h2 id="state">SYSTEM IDLE</h2>
    <p>Next cycle in <span id="count">--</span>s</p>
    <div id="spinner"></div>
</div>

<div id="ad"></div>

<script>
/* ================= CONFIG ================= */
const SMARTLINK = "https://www.effectivegatecpm.com/cw1ee9zt3?key=166a8de6e9417228de30d751d42c81fb";

const VIEW_TIME = 20000;     // 20 seconds (HARD minimum)
const COOLDOWN = 40000;      // 40 seconds cooldown
const LOAD_TIMEOUT = 12000;  // iframe load timeout (log only)
const HARD_RESET_AFTER = 8;  // cycles before full reload safeguard
/* ========================================== */

let cycle = 0;
let timers = [];
let iframe = null;
let adStartTime = 0;

/* ---------- UTILS ---------- */
function clearAllTimers() {
    timers.forEach(t => clearTimeout(t));
    timers = [];
}

function hardReload(reason) {
    console.warn("HARD RELOAD:", reason);
    location.reload();
}

/* ---------- CYCLE ---------- */
function startCycle() {
    cycle++;
    clearAllTimers();

    console.log("=== CYCLE", cycle, "START ===");

    if (cycle > HARD_RESET_AFTER) {
        hardReload("cycle limit reached");
        return;
    }

    showAd();

    // HARD, FRAUD-SAFE AD END (20s guaranteed)
    timers.push(setTimeout(() => {
        console.log("Ad completed full view time");
        goHome();
    }, VIEW_TIME));
}

/* ---------- AD ---------- */
function showAd() {
    adStartTime = Date.now();

    document.getElementById("home").style.display = "none";

    const ad = document.getElementById("ad");
    ad.style.display = "block";
    ad.innerHTML = "";

    iframe = document.createElement("iframe");
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";

    iframe.onload = () => {
        console.log("iframe onload");
    };

    iframe.src = SMARTLINK;
    ad.appendChild(iframe);

    // LOAD TIMEOUT (LOG ONLY — no early exit)
    timers.push(setTimeout(() => {
        console.warn("iframe load timeout (will recover next cycle)");
    }, LOAD_TIMEOUT));

    // BLANK / POISON DETECTION (LOG ONLY)
    timers.push(setTimeout(() => {
        try {
            const doc = iframe.contentDocument;
            if (!doc || !doc.body || doc.body.innerHTML.trim().length < 30) {
                console.warn("blank iframe detected (will recover next cycle)");
            }
        } catch (e) {
            // Cross-origin → ignore
        }
    }, 4000));
}

/* ---------- HOME / COOLDOWN ---------- */
function goHome() {
    clearAllTimers();

    const ad = document.getElementById("ad");
    ad.style.display = "none";
    ad.innerHTML = "";
    iframe = null;

    const home = document.getElementById("home");
    home.style.display = "flex";

    document.getElementById("state").textContent = "COOLING DOWN";

    let remaining = COOLDOWN / 1000;
    document.getElementById("count").textContent = remaining;

    timers.push(setInterval(() => {
        remaining--;
        document.getElementById("count").textContent = remaining;

        if (remaining <= 0) {
            clearAllTimers();
            startCycle();
        }
    }, 1000));
}

/* ---------- SAFETY ---------- */
window.onerror = () => hardReload("js error");
window.onunhandledrejection = () => hardReload("promise error");

// Absolute PyQt WebEngine failsafe
setTimeout(() => {
    hardReload("time based reset");
}, 15 * 60 * 1000);

/* ---------- START ---------- */
startCycle();
</script>

</body>
</html>
